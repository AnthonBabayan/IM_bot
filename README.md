# Телеграм бот для подачи заявок в ТП через ИнфраМенеджер

Этот Telegram-бот — инструмент для интеграции с ITSM-системой "ИнфраМенеджер". Он служит единой точкой входа для сотрудников компании, позволяя им быстро и удобно создавать заявки в техническую поддержку, прикладывать файлы и отслеживать статус обращений прямо из мессенджера.

---

## Бизнес-ценность

Внедрение этого бота решает несколько ключевых бизнес-задач:

1.  **Снижение нагрузки на 1-ю линию поддержки:** Бот берет на себя рутинные задачи по сбору первичной информации от пользователя (ФИО, категория проблемы, описание, скриншоты), позволяя специалистам поддержки сосредоточиться на решении самих проблем, а не на сборе данных.
2.  **Ускорение регистрации заявок:** Заявка автоматически формируется и отправляется в систему Help Desk по email сразу после того, как пользователь заполнил все данные. Это исключает задержки, связанные с человеческим фактором.
3.  **Повышение удовлетворенности сотрудников:** Предоставляет сотрудникам удобный, привычный и доступный 24/7 канал для связи с техподдержкой через Telegram. Прозрачность (уведомления о статусе заявки) и возможность дать обратную связь повышают лояльность.
4.  **Сбор данных для анализа:** Система оценок и сбор структурированных данных о типах проблем позволяют анализировать качество работы поддержки и выявлять наиболее частые инциденты для их превентивного решения.

---

## Ключевые функции

*   **Безопасная авторизация:** Интеграция с LDAP для верификации сотрудников по корпоративному email. Доступ к боту получают только сотрудники компании.
*   **Интерактивный диалог:** Пошаговый сценарий (wizard) для создания заявки, который ведет пользователя от выбора категории проблемы до ее детального описания.
*   **Отправка вложений:** Возможность прикреплять фотографии и скриншоты для наглядной демонстрации проблемы.
*   **Интеграция с Help Desk:** Автоматическое создание тикета в системе поддержки путем отправки сформированного email-сообщения.
*   **Проверка статуса заявки:** Бот периодически проверяет почтовый ящик (по протоколу POP3) на наличие ответов от системы Help Desk и уведомляет пользователя об изменении статуса его заявки (например, "зарегистрирована" или "выполнена").
*   **Система обратной связи:** После выполнения заявки бот просит пользователя оценить качество предоставленной помощи.
*   **Автоматическое обслуживание:** Фоновые задачи для регулярной очистки устаревших данных (например, сохраненных фотографий).

---

## Архитектура проекта

Проект имеет модульную структуру для обеспечения масштабируемости и простоты поддержки:

-   `main.py`: Главный файл, точка входа. Отвечает за инициализацию, запуск бота и регистрацию обработчиков.
-   `/handlers`: Модули, отвечающие за обработку команд и сообщений от пользователя.
    -   `auth_handlers.py`: Логика авторизации.
    -   `conversation_handlers.py`: Основной диалог создания заявки.
    -   `evaluation_handlers.py`: Логика оценки выполненной заявки.
-   `/services`: Модули для взаимодействия с внешними сервисами и выполнения фоновых задач.
    -   `email_service.py`: Отправка писем для создания заявок.
    -   `mail_checker.py`: Проверка почты и уведомление пользователей о статусе.
    -   `cleanup_service.py`: Очистка старых файлов.
-   `/scripts`: Вспомогательные скрипты для администрирования (например, удаление пользователя).
-   `auth.py`: Логика для работы с LDAP и базой данных авторизации.
-   `db.py`: Функции для работы с основной базой данных заявок.
-   `config.py`: Базовые настройки конфигурации, пути.
-   `constants.py`: Константы состояний диалога.
-   `keyboards.py`: Функции для генерации Telegram-клавиатур.
-   `.gitignore`: Настроен для исключения из репозитория баз данных, логов, фотографий и файлов окружения.
-   `requirements.txt`: Список зависимостей проекта.

---

## Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <URL вашего репозитория>
    cd imbot
    ```

2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    python -m venv venv
    source venv/bin/activate  # Для Windows: venv\Scripts\activate
    ```

3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Настройте конфигурацию:**
    Вам необходимо указать ваши реальные учетные данные и токены в следующих файлах. Замените строки-заполнители (`'YOUR_...'`) на ваши значения.

    -   `main.py`:
        -   `TG_TOKEN`: Токен вашего Telegram-бота.
        -   `LOG_DIR`: Путь к папке для хранения логов.
    -   `auth.py`:
        -   `LDAP_HOST`, `LDAP_PORT`, `LDAP_USER`, `LDAP_PASSWORD`, `LDAP_BASE_DN`: Учетные данные для подключения к вашему LDAP-серверу.
        -   `SMTP_USER`, `SMTP_PASSWORD`: Учетные данные для отправки писем с кодами подтверждения.
    -   `services/email_service.py`:
        -   `SMTP_SERVER`, `SMTP_PORT`, `SMTP_USER`: Настройки SMTP для отправки заявок.
        -   `EMAIL_TO`: Адрес почты вашей системы Help Desk.
    -   `services/mail_checker.py`:
        -   `HOST`, `PORT`, `USERNAME`, `PASSWORD`: Учетные данные POP3 для проверки статуса заявок.

5.  **Инициализируйте базу данных:**
    Базы данных создадутся автоматически при первом запуске, но вы можете запустить `db.py` и `auth.py` для их принудительной инициализации.

6.  **Запустите бота:**
    ```bash
    python main.py
    ```
---

## Использование служебных скриптов

В папке `/scripts` находятся утилиты для ручного управления данными.

-   **`delete_user.py`**: Удаляет пользователя из базы данных авторизации по `user_id` или `email`.
-   **`clear_location.py`**: Очищает данные о местоположении пользователей в базе. 
